# Step 1 建立连接

### mysql 连接器
&emsp;&emsp;在```mysql -uroot -p``` 之后连接器会到权限表中查出用户所拥有的权限，并与该用户建立连接。
<br>
&emsp;&emsp;连接完成后，如果你没有后续的动作，这个连接就处于空闲状态，客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 wait_timeout 控制的，默认值是 8 小时。
<br>
**&emsp;&emsp;数据库里面，长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。**
**&emsp;&emsp;如果全部使用长连接，有些时候 MySQL 占用内存涨得特别快，这是因为 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。**
<br>
&emsp;&emsp;有两种方案可以解决：
<br>
&emsp;&emsp;1.定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。
<br>
&emsp;&emsp;2.如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。
<br>

# Step 2 查询缓存(MYSQL 8.0之后没有这一步)

**SQL-查询结果 会以key-value的格式存储在缓存中，往往弊大于利，因为更新相当于整个表的缓存失效**

# Step 3 分析器

### 词法分析
&emsp;&emsp;你输入的是由多个字符串和空格组成的一条 SQL 语句，MySQL 需要识别出里面的字符串分别是什么，代表什么。
<br>
&emsp;&emsp;比如：MySQL 从你输入的"select"这个关键字识别出来，这是一个查询语句。它也要把字符串“T”识别成“表名 T”，把字符串“ID”识别成“列 ID”。
### 语法分析
&emsp;&emsp;根据词法分析的结果，语法分析器会根据语法规则，判断你输入的这个 SQL 语句是否满足 MySQL 语法。
```agsl
mysql> elect * from t where ID=1;

ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'elect * from t where ID=1' at line 1
```

**如果表 T 中没有字段 k 执行了这个语句 select * from T where k=1, 那肯定是会报“不存在这个列”的错误 也是分析器报出的错误**

# Step 4 优化器
&emsp;&emsp;经过了分析器，MySQL 就知道你要做什么了。在开始执行之前，还要先经过优化器的处理。
<br>
**&emsp;&emsp;优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。比如你执行下面这样的语句，这个语句是执行两个表的 join：**
```agsl
mysql> select * from t1 join t2 using(ID)  where t1.c=10 and t2.d=20;
```

- 既可以先从表 t1 里面取出 c=10 的记录的 ID 值，再根据 ID 值关联到表 t2，再判断 t2 里面 d 的值是否等于 20。
- 也可以先从表 t2 里面取出 d=20 的记录的 ID 值，再根据 ID 值关联到 t1，再判断 t1 里面 c 的值是否等于 10。

具体优化器原理: @TODO 链接


#  Step 5 执行器
&emsp;&emsp;比如我们这个例子中的表 T 中，ID 字段没有索引，那么执行器的执行流程是这样的：
<br>
1. 调用 InnoDB 引擎接口取这个表的第一行，判断 ID 值是不是 10，如果不是则跳过，如果是则将这行存在结果集中；
2. 调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。
3. 执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。至此，这个语句就执行完成了。
<br>
&emsp;&emsp;对于有索引的表，执行的逻辑也差不多。第一次调用的是“取满足条件的第一行”这个接口，之后循环取“满足条件的下一行”这个接口，这些接口都是引擎中已经定义好的。